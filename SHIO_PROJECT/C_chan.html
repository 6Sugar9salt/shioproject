<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gem C: MV Storyboarder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <!-- Google Generative AI SDK -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
        .scene-card:hover {
            border-color: #06b6d4; /* cyan-500 */
            transform: translateY(-2px);
        }
        /* Button States */
        button:disabled { cursor: not-allowed; opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 font-sans min-h-screen selection:bg-cyan-500 selection:text-white pb-20">

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Header -->
        <header class="flex items-center justify-between mb-8 border-b border-gray-800 pb-6">
            <div>
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">
                    Gem C <span class="text-sm text-gray-400 font-normal ml-2">MV Storyboarder</span>
                </h1>
                <p class="text-gray-400 text-sm mt-1">Ê•ΩÊõ≤(Audio)„Å®Ê≠åË©û(Lyrics)„Åã„Çâ„ÄÅÊò†ÂÉèÊºîÂá∫„Ç≥„É≥„ÉÜ(JSON)„ÇíÊßãÁØâ„Åô„Çã„Éá„Ç£„É¨„ÇØ„Çø„Éº„ÉÑ„Éº„É´</p>
            </div>
            <div class="text-right hidden md:block">
                <div class="text-xs text-gray-500 font-mono">TARGET: Google Veo 3.1</div>
                <div class="text-xs text-gray-500 font-mono">MODE: Director's Cut</div>
            </div>
        </header>

        <!-- TOP SECTION: Settings -->
        <div class="glass-panel rounded-xl p-6 shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                
                <!-- 1. API Key -->
                <div class="flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <label class="block text-xs font-bold text-gray-400 uppercase flex items-center gap-2">
                            <i class="fas fa-key text-yellow-500"></i> 1. Google Gemini API Key
                        </label>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-cyan-400 hover:underline">
                            API„Ç≠„Éº„ÇíÂèñÂæó <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                    <input type="password" id="api-key-input" placeholder="AIzaSy..." class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-cyan-500 outline-none transition font-mono">
                    <div class="flex items-center gap-3">
                        <button onclick="checkAvailableModels()" id="check-models-btn" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg text-xs transition shadow-md flex items-center justify-center gap-2 border border-cyan-400/20 whitespace-nowrap">
                            <i class="fas fa-sync-alt"></i> API„Ç≠„ÉºË™≠„ÅøËæº„Åø
                        </button>
                        <p class="text-[10px] text-gray-500 leading-tight">
                            ‚ÄªAPI„Ç≠„ÉºÂÖ•ÂäõÂæå„Å´Êäº„Åô„Å®„ÄÅÂØæÂøú„É¢„Éá„É´„É™„Çπ„Éà„ÇíÂèñÂæó„Åó„Åæ„Åô
                        </p>
                    </div>
                </div>

                <!-- 2. Model Selection -->
                <div class="flex flex-col gap-3">
                    <label class="block text-xs font-bold text-gray-400 uppercase flex items-center gap-2">
                        <i class="fas fa-robot text-cyan-400"></i> 2. Select Model
                    </label>
                    <div class="relative h-[42px]">
                        <select id="model-select" class="w-full h-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-cyan-500 outline-none appearance-none cursor-pointer">
                            <option value="" disabled selected>‚Üê „Åæ„ÅöÂ∑¶„ÅÆ„ÄåAPI„Ç≠„ÉºË™≠„ÅøËæº„Åø„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="gemini-2.5-flash-preview-09-2025" class="hidden">Gemini 2.5 Flash Preview</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-500 text-xs pointer-events-none"></i>
                    </div>
                    <div id="model-check-status" class="text-[10px] font-mono text-gray-500 min-h-[1.5em] flex items-center"></div>
                </div>
            </div>
        </div>

        <!-- MAIN WORKSPACE -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT COLUMN: Inputs (5/12) -->
            <div class="lg:col-span-5 space-y-6">
                
                <!-- 3. Audio Upload -->
                <div class="glass-panel rounded-xl p-6">
                    <h2 class="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-2">
                        <i class="fas fa-music text-pink-400"></i> 3. Audio Track (MP3/WAV)
                    </h2>
                    <div id="drop-zone" class="border-2 border-dashed border-gray-700 rounded-lg p-6 text-center cursor-pointer hover:border-cyan-500 hover:bg-gray-800/50 transition group relative">
                        <input type="file" id="audio-input" accept="audio/*" class="hidden" onchange="handleAudioSelect(this)">
                        
                        <div id="upload-prompt" class="space-y-2 pointer-events-none">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-600 group-hover:text-cyan-400 transition mb-2"></i>
                            <p class="text-gray-300 text-sm font-bold">Ê•ΩÊõ≤„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó</p>
                            <p class="text-gray-600 text-xs">Max size: 20MB (Êé®Â•®)</p>
                        </div>

                        <div id="audio-preview-container" class="hidden absolute inset-0 bg-gray-900 flex flex-col items-center justify-center p-4 rounded-lg">
                            <i class="fas fa-music text-cyan-500 text-2xl mb-2 animate-bounce"></i>
                            <p id="audio-filename" class="text-xs text-cyan-300 mb-2 truncate w-full text-center">filename.mp3</p>
                            <audio id="audio-player" controls class="w-full h-8"></audio>
                            <button onclick="resetAudio(event)" class="absolute top-2 right-2 text-gray-500 hover:text-red-400">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 4. Lyrics Input -->
                <div class="glass-panel rounded-xl p-6">
                    <h2 class="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-2">
                        <i class="fas fa-align-left text-green-400"></i> 4. Lyrics (Optional)
                    </h2>
                    <textarea id="lyrics-input" rows="6" placeholder="Ê≠åË©û„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ..." class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm focus:border-green-500 outline-none transition placeholder-gray-700 resize-none font-sans leading-relaxed"></textarea>
                </div>

                <!-- 5. Director's Note -->
                <div class="glass-panel rounded-xl p-6 border-l-4 border-l-cyan-500">
                    <h2 class="text-xs font-bold text-cyan-400 uppercase mb-3 flex items-center gap-2">
                        <i class="fas fa-clapperboard"></i> 5. Director's Note (ÊºîÂá∫ÊåáÁ§∫)
                    </h2>
                    <textarea id="note-input" rows="4" placeholder="‰æãÔºöÂÖ®‰ΩìÁöÑ„Å´„Çµ„Ç§„Éê„Éº„Éë„É≥„ÇØ„Å™‰∏ñÁïåË¶≥„Åß„ÄÇA„É°„É≠„ÅØÂ≠§Áã¨„ÅßÊöó„Åè„ÄÅ„Çµ„Éì„Åß„Éç„Ç™„É≥„ÅåÁàÜÁô∫„Åô„Çã„Çà„ÅÜ„Å™ÊøÄ„Åó„ÅÑ„Ç´„É°„É©„ÉØ„Éº„ÇØ„Å´„Åó„Å¶„ÄÇÊúÄÂæå„ÅØÈõ®„ÅÆ‰∏≠„ÅßÁµÇ„Çè„Çâ„Åõ„Å¶„ÄÇ" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm focus:border-cyan-500 outline-none transition placeholder-gray-700 resize-none"></textarea>
                </div>

                <!-- Action Buttons: 2-Step Process -->
                <div class="grid grid-cols-2 gap-3">
                    <!-- Step 1: Generate -->
                    <button id="generate-btn" onclick="generateStoryboard()" class="col-span-1 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed flex flex-col items-center justify-center gap-1 border border-white/10 group">
                        <span class="flex items-center gap-2 text-base"><i class="fas fa-video"></i> „Ç≥„É≥„ÉÜ„ÇíÁîüÊàê</span>
                        <span class="text-[10px] opacity-70 font-normal">(Generate Master JSON)</span>
                    </button>
                    
                    <!-- Step 2: Translate -->
                    <button id="translate-btn" onclick="translateStoryboard()" disabled class="col-span-1 bg-gray-700 hover:bg-green-600 text-gray-300 hover:text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed flex flex-col items-center justify-center gap-1 border border-white/5 group-hover:border-white/20">
                        <span class="flex items-center gap-2 text-base"><i class="fas fa-language"></i> Êó•Êú¨Ë™ûË®≥„ÇíË°®Á§∫</span>
                        <span class="text-[10px] opacity-70 font-normal">(Display Japanese UI Only)</span>
                    </button>
                </div>

            </div>

            <!-- RIGHT COLUMN: Output (7/12) -->
            <div class="lg:col-span-7 flex flex-col h-full min-h-[600px] gap-6">
                
                <!-- Main JSON Output -->
                <div class="glass-panel rounded-xl p-1 flex flex-col relative overflow-hidden border border-gray-700 min-h-[400px]">
                    <div class="bg-gray-800/50 px-4 py-3 border-b border-gray-700 flex justify-between items-center">
                        <h2 class="text-sm font-bold text-white flex items-center gap-2">
                            <i class="fas fa-list-ol text-cyan-400"></i> Scene List (Master JSON)
                        </h2>
                        <span id="status-indicator" class="text-[10px] font-mono text-gray-500 bg-gray-900 px-2 py-1 rounded border border-gray-700">WAITING FOR INPUT</span>
                    </div>

                    <div class="flex-1 relative">
                        <textarea id="output-json" readonly class="w-full h-full bg-gray-900/80 p-6 font-mono text-xs text-cyan-300 focus:outline-none resize-none leading-relaxed" placeholder="// ÊâãÈ†Ü1: „Ç≥„É≥„ÉÜÁîüÊàê„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅ„Åì„Åì„Å´AIÁõ£Áù£„ÅÆÊºîÂá∫ÔºàËã±Ë™ûÔºâ„ÅåÂá∫Âäõ„Åï„Çå„Åæ„Åô„ÄÇ&#10;// ÊâãÈ†Ü2: Êó•Êú¨Ë™ûË®≥„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅ‰∏ã„ÅÆ„Ç´„Éº„ÉâË°®Á§∫„ÅÆ„ÅøÊó•Êú¨Ë™ûÂåñ„Åï„Çå„Åæ„ÅôÔºà„Åì„ÅÆJSON„ÅØËã±Ë™û„ÅÆ„Åæ„Åæ‰øùÊåÅ„Åï„Çå„Åæ„ÅôÔºâ„ÄÇ"></textarea>
                        
                        <!-- Loading Overlay -->
                        <div id="loading-overlay" class="absolute inset-0 bg-gray-900/95 backdrop-blur-sm flex flex-col items-center justify-center hidden z-20 transition-all duration-300">
                            <div class="relative w-24 h-24 mb-6">
                                <div class="absolute inset-0 border-t-2 border-cyan-500 rounded-full animate-spin"></div>
                                <div class="absolute inset-4 border-t-2 border-blue-500 rounded-full animate-spin reverse-spin"></div>
                                <i id="loading-icon" class="fas fa-headphones absolute inset-0 flex items-center justify-center text-gray-600 text-2xl animate-pulse"></i>
                            </div>
                            <p id="loading-text" class="text-cyan-400 text-sm font-bold animate-pulse tracking-widest">DIRECTING...</p>
                            <p id="loading-detail" class="text-gray-500 text-xs mt-2 font-mono">Processing...</p>
                        </div>
                    </div>

                    <div class="bg-gray-800/50 px-4 py-3 border-t border-gray-700 flex gap-3 justify-end">
                        <button onclick="copyJson()" id="copy-btn" disabled class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-xs font-bold transition disabled:opacity-50">
                            <i class="fas fa-copy mr-1"></i> Copy Master
                        </button>
                        <button onclick="downloadJson()" id="download-btn" disabled class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-xs font-bold transition disabled:opacity-50 shadow-lg shadow-cyan-900/20">
                            <i class="fas fa-download mr-1"></i> Download Master .json
                        </button>
                    </div>
                </div>

                <!-- Scene Manager -->
                <div id="scene-manager" class="glass-panel rounded-xl p-6 hidden">
                    <h2 class="text-sm font-bold text-gray-200 mb-4 flex items-center justify-between">
                        <span class="flex items-center gap-2"><i class="fas fa-film text-cyan-400"></i> Scene Manager</span>
                        <span class="text-[10px] text-gray-500 font-normal">Individual Scene Export</span>
                    </h2>
                    <div id="scene-list-container" class="grid grid-cols-1 gap-3 max-h-[500px] overflow-y-auto pr-2"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- HELPER: Robust JSON Extractor ---
        function extractAndParseJSON(text) {
            try {
                let cleaned = text.replace(/```json\n?|```/g, '').trim();
                
                // Locate JSON boundaries
                const firstCurly = cleaned.indexOf('{');
                const firstSquare = cleaned.indexOf('[');
                
                let start = -1;
                let end = -1;
                
                // Prioritize array if it appears before object or if no object is found
                if (firstSquare !== -1 && (firstCurly === -1 || firstSquare < firstCurly)) {
                    start = firstSquare;
                    end = cleaned.lastIndexOf(']');
                } else if (firstCurly !== -1) {
                    start = firstCurly;
                    end = cleaned.lastIndexOf('}');
                }
                
                if (start !== -1 && end !== -1) {
                    cleaned = cleaned.substring(start, end + 1);
                }

                return JSON.parse(cleaned);
            } catch (e) {
                console.error("JSON Parsing Failed. Raw text:", text);
                throw new Error("Failed to parse JSON response.");
            }
        }

        // --- GLOBAL STATE ---
        let masterJsonData = null; 

        // --- PHASE 1: GENERATE (Director Mode) ---
        const SYSTEM_INSTRUCTION_GENERATE = `
# Role
You are a top-tier Music Video Director and Visual Storyteller for Google Veo 3.1.
Your task is to listen to the audio track, analyze the lyrics and the Director's Note, and create a "Scene Storyboard" (JSON format).

# Process & Philosophy
1. **Listen & Feel**: Analyze the audio's tempo, energy, and mood changes.
2. **Interpret**: Translate lyrics and mood into visual metaphors.
   - **CRITICAL RULE**: Do NOT quote Japanese lyrics directly in the output. When referring to lyrics, describe their meaning in English only (e.g. "The lyrics talk about looking back...").
3. **Pacing**: Divide the video into cuts that match the music's structure.
   - **Crucial Rule**: Avoid cuts longer than 8 seconds. If a musical segment is long, split it into multiple camera angles.
   - **Editing Handles**: Always calculate 'generation_duration' to be 1-2 seconds longer than 'musical_duration'.

# Output JSON Structure
Output ONLY a JSON object with a "scenes" array.
Each scene object must contain:
- \`scene_id\`: Sequential ID (001, 002...)
- \`segment\`: Musical part (Intro, Verse 1, Chorus...)
- \`musical_duration\`: Actual length in music (seconds)
- \`generation_duration\`: Recommended generation length (approx +2.0s buffer, max 8.0s)
- \`director_note\`: Your reasoning for this cut in English (e.g., "The song refers to a switch, so I start with...")
- \`veo_prompt_elements\`:
    - \`action\`: What happens? (e.g., Character looks back)
    - \`camera\`: Camera movement (e.g., Dolly zoom, Static, Low angle)
    - \`lighting\`: Lighting setup (e.g., Neon strobe, Golden hour, Dark moody)
    - \`environment\`: Short description of place (e.g., Rainy cyberpunk street)
`;

        // --- PHASE 2: TRANSLATE (Translator Mode) ---
        const SYSTEM_INSTRUCTION_TRANSLATE = `
# Role
You are a professional Translator for Video Production.

# Task
1. Read the input JSON (English Storyboard).
2. For each scene, generate a concise JAPANESE description ("description_ja") based on the English content.
3. **CRITICAL**: To save output space, return ONLY a JSON object mapping "scene_id" to "description_ja". Do NOT repeat the English content.

# Output Format Example
{
  "001": "„Ç§„É≥„Éà„É≠„ÄÇ„Éç„Ç™„É≥„ÅÆ„Çπ„Ç§„ÉÉ„ÉÅ„Åå...",
  "002": "„É¥„Ç°„Éº„Çπ1„ÄÇÂ±ÖÂøÉÂú∞„ÅÆËâØ„ÅÑÈÉ®Â±ã„Åß..."
}
        `;


        // --- UI State ---
        let currentAudioFile = null;
        let audioBase64 = null;
        let isTranslated = false; 

        // --- DOM Elements ---
        const apiKeyInput = document.getElementById('api-key-input');
        const modelSelect = document.getElementById('model-select');
        const audioInput = document.getElementById('audio-input');
        const dropZone = document.getElementById('drop-zone');
        const audioPreviewContainer = document.getElementById('audio-preview-container');
        const audioPlayer = document.getElementById('audio-player');
        const audioFilename = document.getElementById('audio-filename');
        const uploadPrompt = document.getElementById('upload-prompt');
        const sceneManager = document.getElementById('scene-manager');
        const sceneListContainer = document.getElementById('scene-list-container');
        
        // Buttons
        const generateBtn = document.getElementById('generate-btn');
        const translateBtn = document.getElementById('translate-btn');

        // --- API & Model Logic ---
        window.checkAvailableModels = async () => {
            const apiKey = apiKeyInput.value.trim();
            const statusDiv = document.getElementById('model-check-status');
            const checkBtn = document.getElementById('check-models-btn');
            
            if (!apiKey) {
                statusDiv.textContent = "API Key required.";
                statusDiv.className = "text-[10px] font-mono text-red-400 mt-2";
                return;
            }

            statusDiv.textContent = "Checking models...";
            statusDiv.className = "text-[10px] font-mono text-yellow-400 animate-pulse mt-2";
            checkBtn.disabled = true;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error.message);
                
                if (data.models) {
                    const relevantModels = data.models.filter(m => 
                        m.supportedGenerationMethods && 
                        m.supportedGenerationMethods.includes("generateContent") &&
                        (m.name.includes("gemini") || m.name.includes("3.0") || m.name.includes("2.5")) &&
                        !m.name.includes("tts") 
                    ).sort((a, b) => b.name.localeCompare(a.name));

                    modelSelect.innerHTML = ""; 
                    const group = document.createElement('optgroup');
                    group.label = "Detected Available Models";
                    group.className = "text-gray-900 bg-white";
                    
                    let foundPreferred = false;

                    relevantModels.forEach(m => {
                        const option = document.createElement('option');
                        const modelId = m.name.replace('models/', '');
                        option.value = modelId;
                        let displayName = modelId;
                        if (modelId.includes("flash")) displayName = "‚ö° " + modelId + " (Fast)";
                        else if (modelId.includes("pro")) displayName = "üß† " + modelId + " (High Reasoning)";
                        option.textContent = displayName;
                        group.appendChild(option);
                    });
                    modelSelect.appendChild(group);
                    
                    const opts = modelSelect.options;
                    for(let i=0; i<opts.length; i++) {
                         if(opts[i].value.includes("2.5-flash")) {
                             modelSelect.selectedIndex = i;
                             foundPreferred = true;
                             break;
                         }
                    }

                    const count = relevantModels.length;
                    statusDiv.textContent = `OK: ${count} models found.`;
                    statusDiv.className = "text-[10px] font-mono text-green-400 mt-2";
                }

            } catch (e) {
                console.error(e);
                statusDiv.textContent = "Error: Invalid API Key";
                statusDiv.className = "text-[10px] font-mono text-red-400 mt-2";
            } finally {
                checkBtn.disabled = false;
            }
        };

        // --- Audio Handling ---
        dropZone.addEventListener('click', (e) => {
            if(e.target !== document.getElementById('reset-audio-btn')) audioInput.click();
        });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-cyan-500', 'bg-gray-800'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-cyan-500', 'bg-gray-800'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-cyan-500', 'bg-gray-800');
            if (e.dataTransfer.files.length) handleAudioFile(e.dataTransfer.files[0]);
        });
        window.handleAudioSelect = (input) => { if (input.files.length) handleAudioFile(input.files[0]); };
        window.resetAudio = (e) => {
            e.stopPropagation();
            currentAudioFile = null;
            audioBase64 = null;
            audioInput.value = '';
            audioPlayer.src = '';
            audioPreviewContainer.classList.add('hidden');
            uploadPrompt.classList.remove('hidden');
            generateBtn.disabled = false;
            translateBtn.disabled = true;
        };

        function handleAudioFile(file) {
            if (!file.type.startsWith('audio/')) { alert('Audio file only'); return; }
            if (file.size > 20 * 1024 * 1024) { alert('File is too large (Max 20MB).'); return; }

            currentAudioFile = file;
            audioFilename.textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                audioPlayer.src = e.target.result;
                audioPreviewContainer.classList.remove('hidden');
                uploadPrompt.classList.add('hidden');
                audioBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        // --- Render Logic ---
        function renderSceneList(jsonObj, showJapanese = false) {
            try {
                let scenes = [];
                if (Array.isArray(jsonObj)) {
                    scenes = jsonObj;
                } else if (jsonObj && Array.isArray(jsonObj.scenes)) {
                    scenes = jsonObj.scenes;
                } else {
                    console.warn("Invalid structure for renderSceneList", jsonObj);
                    return;
                }

                sceneListContainer.innerHTML = "";
                sceneManager.classList.remove('hidden');

                scenes.forEach(scene => {
                    const sceneDiv = document.createElement('div');
                    sceneDiv.className = "scene-card bg-gray-900 border border-gray-700 rounded-lg p-3 flex justify-between items-start transition-all";
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = "flex-1 mr-4";
                    
                    const header = document.createElement('div');
                    header.className = "flex items-center gap-2 mb-2";
                    header.innerHTML = `
                        <span class="text-cyan-400 font-bold text-xs">ID: ${scene.scene_id}</span>
                        <span class="bg-gray-800 text-gray-400 text-[10px] px-1.5 py-0.5 rounded border border-gray-700">${scene.segment || 'Scene'}</span>
                        <span class="text-gray-500 text-[10px] font-mono"><i class="far fa-clock"></i> ${scene.generation_duration}s</span>
                    `;
                    
                    let mainText = "";
                    let subText = "";

                    if (showJapanese && scene.description_ja) {
                        mainText = scene.description_ja; 
                        subText = scene.director_note || ""; 
                    } else {
                        mainText = scene.director_note || scene.veo_prompt_elements?.action || "No description";
                        subText = "(Êú™ÁøªË®≥ - Ëã±Ë™û„ÅÆ„Åæ„ÅæË°®Á§∫‰∏≠)";
                    }

                    const mainP = document.createElement('p');
                    mainP.className = showJapanese ? "text-gray-200 text-sm font-bold mb-1 leading-relaxed" : "text-gray-300 text-xs leading-relaxed";
                    mainP.textContent = mainText;

                    const subP = document.createElement('p');
                    subP.className = "text-gray-500 text-[10px] font-mono line-clamp-2 mt-1 border-t border-gray-800 pt-1";
                    subP.textContent = subText;

                    infoDiv.appendChild(header);
                    infoDiv.appendChild(mainP);
                    infoDiv.appendChild(subP);

                    const actionDiv = document.createElement('div');
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = "text-gray-400 hover:text-cyan-400 transition p-2";
                    downloadBtn.title = "Download this scene (English Only)"; 
                    downloadBtn.innerHTML = '<i class="fas fa-file-download text-lg"></i>';
                    
                    downloadBtn.onclick = () => downloadSingleScene(scene);

                    actionDiv.appendChild(downloadBtn);
                    sceneDiv.appendChild(infoDiv);
                    sceneDiv.appendChild(actionDiv);
                    sceneListContainer.appendChild(sceneDiv);
                });

            } catch (e) {
                console.error("Failed to render list", e);
            }
        }

        // --- FIX: Remove Japanese field before downloading single scene ---
        window.downloadSingleScene = (sceneObj) => {
            const cleanScene = { ...sceneObj };
            
            if (cleanScene.description_ja) {
                delete cleanScene.description_ja;
            }

            const filename = `Scene_${cleanScene.scene_id}_${cleanScene.segment.replace(/\s+/g, '_') || 'clip'}.json`;
            const content = JSON.stringify(cleanScene, null, 2);
            
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // --- PHASE 1: Generate Storyboard ---
        window.generateStoryboard = async () => {
            const apiKey = apiKeyInput.value.trim();
            const modelName = modelSelect.value;
            const lyrics = document.getElementById('lyrics-input').value;
            const note = document.getElementById('note-input').value;
            const outputArea = document.getElementById('output-json');
            
            const loading = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const loadingDetail = document.getElementById('loading-detail');
            const loadingIcon = document.getElementById('loading-icon');
            const status = document.getElementById('status-indicator');

            if (!apiKey) { alert('API Key required.'); return; }
            if (!modelName) { alert('Please select a model.'); return; }
            if (!audioBase64) { alert('Please upload audio.'); return; }

            loading.classList.remove('hidden');
            loadingText.textContent = "DIRECTING...";
            loadingIcon.setAttribute('class', "fas fa-headphones absolute inset-0 flex items-center justify-center text-gray-600 text-2xl animate-pulse");
            
            sceneManager.classList.add('hidden');
            translateBtn.disabled = true;
            translateBtn.classList.remove('bg-green-600', 'text-white');
            translateBtn.classList.add('bg-gray-700', 'text-gray-300');
            translateBtn.innerHTML = '<span class="flex items-center gap-2 text-base"><i class="fas fa-language"></i> Êó•Êú¨Ë™ûË®≥„ÇíË°®Á§∫</span><span class="text-[10px] opacity-70 font-normal">(Display Japanese UI)</span>';
            generateBtn.disabled = true;
            isTranslated = false;
            masterJsonData = null; // Reset Master

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ 
                    model: modelName,
                    systemInstruction: SYSTEM_INSTRUCTION_GENERATE,
                    generationConfig: { responseMimeType: "application/json" } // FIX: FORCE JSON MODE
                });

                let userPrompt = "Analyze this audio track.";
                if (lyrics) userPrompt += `\n\nLyrics:\n${lyrics}`;
                if (note) userPrompt += `\n\nDirector's Note:\n${note}`;
                userPrompt += "\n\nCreate a detailed scene-by-scene storyboard JSON.";

                const audioPart = { inlineData: { data: audioBase64, mimeType: currentAudioFile.type } };

                loadingDetail.textContent = "Listening & planning cuts...";

                const result = await model.generateContent([userPrompt, audioPart]);
                const response = await result.response;
                let text = response.text();
                
                let rawJson = extractAndParseJSON(text);
                
                // Normalize structure (Array -> Object with scenes property)
                if (Array.isArray(rawJson)) {
                    masterJsonData = { scenes: rawJson };
                } else {
                    masterJsonData = rawJson;
                }

                status.textContent = "GENERATED (MASTER: EN)";
                status.className = "text-[10px] font-mono text-cyan-400 bg-gray-900 px-2 py-1 rounded border border-cyan-900";
                
                outputArea.value = JSON.stringify(masterJsonData, null, 2);
                
                renderSceneList(masterJsonData, false);

                translateBtn.disabled = false;
                document.getElementById('copy-btn').disabled = false;
                document.getElementById('download-btn').disabled = false;

            } catch (error) {
                console.error(error);
                outputArea.value = "Error: " + error.message;
                status.textContent = "ERROR";
                status.className = "text-[10px] font-mono text-red-500 bg-gray-900 px-2 py-1 rounded border border-red-900";
            } finally {
                loading.classList.add('hidden');
                generateBtn.disabled = false;
            }
        };

        // --- PHASE 2: Translate Storyboard ---
        window.translateStoryboard = async () => {
            const apiKey = apiKeyInput.value.trim();
            const modelName = modelSelect.value;
            
            if (!masterJsonData) return;
            const currentJsonStr = JSON.stringify(masterJsonData); 
            
            const loading = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const loadingDetail = document.getElementById('loading-detail');
            const loadingIcon = document.getElementById('loading-icon');
            const status = document.getElementById('status-indicator');

            loading.classList.remove('hidden');
            loadingText.textContent = "TRANSLATING...";
            loadingDetail.textContent = "Adding Japanese descriptions for UI...";
            loadingIcon.setAttribute('class', "fas fa-language absolute inset-0 flex items-center justify-center text-green-500 text-2xl animate-pulse");
            
            translateBtn.disabled = true;

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ 
                    model: modelName, 
                    systemInstruction: SYSTEM_INSTRUCTION_TRANSLATE,
                    generationConfig: { responseMimeType: "application/json" } // FIX: FORCE JSON MODE
                });

                const userPrompt = `Input JSON:\n${currentJsonStr}\n\nTask: Generate Japanese descriptions map.`;

                const result = await model.generateContent([userPrompt]);
                const response = await result.response;
                let text = response.text();

                const translationMap = extractAndParseJSON(text);

                // Merge Translation into Display Data
                const displayScenes = masterJsonData.scenes.map(scene => {
                    const newScene = { ...scene };
                    // Try exact match or match by number
                    let ja = translationMap[scene.scene_id];
                    if (!ja) {
                        const idNum = parseInt(scene.scene_id, 10);
                        ja = translationMap[idNum] || translationMap[String(idNum)];
                    }
                    if (ja) {
                        newScene.description_ja = ja;
                    }
                    return newScene;
                });
                
                const displayJsonObj = { ...masterJsonData, scenes: displayScenes };

                status.textContent = "UI TRANSLATED (MASTER KEPT EN)";
                status.className = "text-[10px] font-mono text-green-400 bg-gray-900 px-2 py-1 rounded border border-green-900";

                renderSceneList(displayJsonObj, true); 
                
                translateBtn.innerHTML = '<span class="flex items-center gap-2 text-base"><i class="fas fa-check"></i> ÁøªË®≥Ë°®Á§∫‰∏≠</span><span class="text-[10px] opacity-70 font-normal">(UI Only)</span>';
                translateBtn.classList.remove('bg-gray-700', 'text-gray-300');
                translateBtn.classList.add('bg-green-600', 'text-white');
                isTranslated = true;

            } catch (error) {
                console.error(error);
                alert("Translation failed: " + error.message);
                status.textContent = "TRANSLATION ERROR";
                status.className = "text-[10px] font-mono text-yellow-500 bg-gray-900 px-2 py-1 rounded border border-yellow-900";
                translateBtn.disabled = false;
            } finally {
                loading.classList.add('hidden');
            }
        };

        window.downloadJson = () => {
            if (!masterJsonData) return;
            const content = JSON.stringify(masterJsonData, null, 2);
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "gem_c_master_storyboard.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.copyJson = () => {
            const content = document.getElementById('output-json'); // This still holds English
            content.select();
            document.execCommand('copy');
            alert('Master JSON (English) copied to clipboard');
        };
    </script>
</body>
</html>